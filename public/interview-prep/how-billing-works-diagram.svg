<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1100 1320" font-family="Arial, sans-serif">
  <defs>
    <marker id="arr" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2E75B6"/>
    </marker>
    <marker id="arrDark" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#1B2A4A"/>
    </marker>
    <marker id="arrGray" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#999"/>
    </marker>
    <marker id="arrGreen" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2D8C4E"/>
    </marker>
    <marker id="arrRed" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#CC3333"/>
    </marker>
    <filter id="sh" x="-1%" y="-1%" width="102%" height="102%">
      <feDropShadow dx="1.5" dy="1.5" stdDeviation="2" flood-color="#00000015"/>
    </filter>
    <linearGradient id="tg" x1="0" y1="0" x2="1" y2="0">
      <stop offset="0%" stop-color="#1B2A4A"/>
      <stop offset="100%" stop-color="#2E75B6"/>
    </linearGradient>
  </defs>
  <!-- Background -->
  <rect width="1100" height="1320" fill="#F8FAFE" rx="10"/>
  <!-- Title -->
  <rect x="0" y="0" width="1100" height="58" fill="url(#tg)" rx="10"/>
  <rect x="0" y="30" width="1100" height="28" fill="url(#tg)"/>
  <text x="550" y="32" text-anchor="middle" fill="white" font-size="19" font-weight="bold">Cable MSO Billing Pipeline &#x2014; Two Processing Modes</text>
  <text x="550" y="50" text-anchor="middle" fill="#AACCEE" font-size="12">Continuous Event Processing (daily) + Batch Cycle Execution (4x/month)</text>
  <!-- ===== SOURCE SYSTEMS ===== -->
  <text x="550" y="85" text-anchor="middle" fill="#1B2A4A" font-size="12" font-weight="bold" letter-spacing="1.5">SOURCE SYSTEMS</text>
  <rect x="40" y="97" width="220" height="65" rx="8" fill="#E8F0FE" stroke="#2E75B6" stroke-width="1.5" filter="url(#sh)"/>
  <text x="150" y="118" text-anchor="middle" fill="#1B2A4A" font-size="12" font-weight="bold">Provisioning</text>
  <text x="150" y="134" text-anchor="middle" fill="#555" font-size="9.5">Service orders, profiles</text>
  <text x="150" y="148" text-anchor="middle" fill="#2E75B6" font-size="9">&#x2192; Recurring charges</text>
  <rect x="285" y="97" width="220" height="65" rx="8" fill="#E8F0FE" stroke="#2E75B6" stroke-width="1.5" filter="url(#sh)"/>
  <text x="395" y="118" text-anchor="middle" fill="#1B2A4A" font-size="12" font-weight="bold">Voice Switch</text>
  <text x="395" y="134" text-anchor="middle" fill="#555" font-size="9.5">Telephony CDRs (subset)</text>
  <text x="395" y="148" text-anchor="middle" fill="#2E75B6" font-size="9">&#x2192; Usage events</text>
  <rect x="530" y="97" width="220" height="65" rx="8" fill="#E8F0FE" stroke="#2E75B6" stroke-width="1.5" filter="url(#sh)"/>
  <text x="640" y="118" text-anchor="middle" fill="#1B2A4A" font-size="12" font-weight="bold">VOD / PPV</text>
  <text x="640" y="134" text-anchor="middle" fill="#555" font-size="9.5">On-demand purchases</text>
  <text x="640" y="148" text-anchor="middle" fill="#2E75B6" font-size="9">&#x2192; Purchase events</text>
  <rect x="775" y="97" width="270" height="65" rx="8" fill="#E8F0FE" stroke="#2E75B6" stroke-width="1.5" filter="url(#sh)"/>
  <text x="910" y="118" text-anchor="middle" fill="#1B2A4A" font-size="12" font-weight="bold">Equipment Mgmt</text>
  <text x="910" y="134" text-anchor="middle" fill="#555" font-size="9.5">STBs, modems, DVRs</text>
  <text x="910" y="148" text-anchor="middle" fill="#2E75B6" font-size="9">&#x2192; Equipment rental charges</text>
  <!-- Merge arrows -->
  <line x1="150" y1="162" x2="150" y2="182" stroke="#2E75B6" stroke-width="1"/>
  <line x1="395" y1="162" x2="395" y2="182" stroke="#2E75B6" stroke-width="1"/>
  <line x1="640" y1="162" x2="640" y2="182" stroke="#2E75B6" stroke-width="1"/>
  <line x1="910" y1="162" x2="910" y2="182" stroke="#2E75B6" stroke-width="1"/>
  <line x1="150" y1="182" x2="910" y2="182" stroke="#2E75B6" stroke-width="1.5"/>
  <line x1="530" y1="182" x2="530" y2="205" stroke="#2E75B6" stroke-width="2" marker-end="url(#arr)"/>
  <!-- ========================================== -->
  <!-- MODE 1: CONTINUOUS PROCESSING -->
  <!-- ========================================== -->
  <rect x="30" y="208" width="1040" height="350" rx="10" fill="#F0F8F0" stroke="#2D8C4E" stroke-width="2"/>
  <rect x="30" y="208" width="1040" height="32" rx="10" fill="#2D8C4E"/>
  <rect x="30" y="222" width="1040" height="18" fill="#2D8C4E"/>
  <text x="50" y="230" fill="white" font-size="13" font-weight="bold">MODE 1 &#x2014; CONTINUOUS EVENT PROCESSING</text>
  <text x="580" y="230" fill="#B8E6B8" font-size="11">Real-time / near-real-time &#x2014; charges accumulate daily as events occur</text>
  <!-- Continuous indicator -->
  <rect x="870" y="245" width="180" height="28" rx="14" fill="#D4EDDA" stroke="#2D8C4E" stroke-width="1"/>
  <text x="960" y="264" text-anchor="middle" fill="#2D8C4E" font-size="10" font-weight="bold">&#x27F3; RUNS CONTINUOUSLY</text>
  <!-- MEDIATION -->
  <rect x="60" y="252" width="780" height="85" rx="10" fill="white" stroke="#2D8C4E" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="274" fill="#1B2A4A" font-size="13" font-weight="bold">MEDIATION</text>
  <text x="210" y="274" fill="#2D8C4E" font-size="10" font-weight="bold">Collect &#x2192; Validate &#x2192; Normalize &#x2192; Deduplicate</text>
  <text x="80" y="296" fill="#555" font-size="10.5">Billing events ingested as they arrive, validated, normalized into standard format</text>
  <text x="80" y="314" fill="#555" font-size="10.5">Output: Clean billing events staged for rating</text>
  <text x="80" y="330" fill="#2E75B6" font-size="9.5" font-weight="bold">CHECKPOINT 1 &#x2014; Event counts &amp; source totals</text>
  <line x1="450" y1="337" x2="450" y2="358" stroke="#2D8C4E" stroke-width="2" marker-end="url(#arrGreen)"/>
  <!-- RATING -->
  <rect x="60" y="361" width="780" height="85" rx="10" fill="white" stroke="#2D8C4E" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="383" fill="#1B2A4A" font-size="13" font-weight="bold">RATING ENGINE</text>
  <text x="250" y="383" fill="#2D8C4E" font-size="10" font-weight="bold">Rate Plan &#x2192; Price &#x2192; Prorate &#x2192; Discount &#x2192; Per-Event Tax</text>
  <text x="80" y="405" fill="#555" font-size="10.5">Each billing event gets a dollar amount. Individual transaction-level tax applied.</text>
  <text x="80" y="423" fill="#555" font-size="10.5">Output: Rated transactions ready for ledger posting</text>
  <text x="80" y="439" fill="#2E75B6" font-size="9.5" font-weight="bold">CHECKPOINT 2 &#x2014; Rated transaction counts &amp; dollar totals</text>
  <line x1="450" y1="446" x2="450" y2="467" stroke="#2D8C4E" stroke-width="2" marker-end="url(#arrGreen)"/>
  <!-- LEDGER POSTING -->
  <rect x="60" y="470" width="780" height="75" rx="10" fill="white" stroke="#1B2A4A" stroke-width="2" filter="url(#sh)"/>
  <rect x="60" y="470" width="780" height="25" rx="10" fill="#1B2A4A"/>
  <rect x="60" y="482" width="780" height="13" fill="#1B2A4A"/>
  <text x="80" y="490" fill="white" font-size="13" font-weight="bold">BILLING LEDGER &#x2014; Charge Posting</text>
  <text x="430" y="490" fill="#FFD700" font-size="10" font-weight="bold">TMF-protected per transaction</text>
  <text x="80" y="515" fill="#555" font-size="10.5">Individual rated charges posted to subscriber accounts. Balances accumulate.</text>
  <text x="80" y="533" fill="#555" font-size="10.5">CSR can see unbilled charges in real time. Charges exist but are NOT YET INVOICED.</text>
  <text x="675" y="533" fill="#2E75B6" font-size="9.5" font-weight="bold">CHECKPOINT 3</text>
  <!-- Divider between modes -->
  <rect x="30" y="565" width="1040" height="40" fill="white" stroke="#DDD" stroke-width="1"/>
  <text x="550" y="582" text-anchor="middle" fill="#1B2A4A" font-size="11">&#x25B2; Charges accumulate continuously on ledger &#x25B2;</text>
  <text x="550" y="598" text-anchor="middle" fill="#1B2A4A" font-size="11">&#x25BC; Cycle batch draws the line and produces invoices &#x25BC;</text>
  <!-- Arrow connecting modes -->
  <line x1="550" y1="605" x2="550" y2="630" stroke="#1B2A4A" stroke-width="2" marker-end="url(#arrDark)"/>
  <!-- ========================================== -->
  <!-- MODE 2: BATCH CYCLE EXECUTION -->
  <!-- ========================================== -->
  <rect x="30" y="633" width="1040" height="380" rx="10" fill="#FFF8F0" stroke="#D4A017" stroke-width="2"/>
  <rect x="30" y="633" width="1040" height="32" rx="10" fill="#D4A017"/>
  <rect x="30" y="647" width="1040" height="18" fill="#D4A017"/>
  <text x="50" y="655" fill="white" font-size="13" font-weight="bold">MODE 2 &#x2014; BATCH CYCLE EXECUTION (the &#x201C;Bill Run&#x201D;)</text>
  <text x="580" y="655" fill="#FFF3CD" font-size="11">4x per month &#x2014; 1.25M subscribers per cycle &#x2014; THIS IS WHERE THE FAILURE HIT</text>
  <!-- Batch indicator -->
  <rect x="870" y="670" width="180" height="28" rx="14" fill="#FFF3CD" stroke="#D4A017" stroke-width="1"/>
  <text x="960" y="689" text-anchor="middle" fill="#856404" font-size="10" font-weight="bold">&#x23F1; BATCH &#x2014; 4x/MONTH</text>
  <!-- Step boxes in the batch -->
  <rect x="60" y="678" width="380" height="60" rx="8" fill="white" stroke="#D4A017" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="700" fill="#1B2A4A" font-size="12" font-weight="bold">1. Cycle Aggregation</text>
  <text x="80" y="717" fill="#555" font-size="10">Accumulate all posted charges since last invoice into</text>
  <text x="80" y="730" fill="#555" font-size="10">statement period. Compute account-level totals.</text>
  <rect x="460" y="678" width="380" height="60" rx="8" fill="white" stroke="#D4A017" stroke-width="1.5" filter="url(#sh)"/>
  <text x="480" y="700" fill="#1B2A4A" font-size="12" font-weight="bold">2. Statement Calculation</text>
  <text x="480" y="717" fill="#555" font-size="10">Prior balance + payments + adjustments +</text>
  <text x="480" y="730" fill="#555" font-size="10">new charges = amount due</text>
  <line x1="250" y1="738" x2="250" y2="755" stroke="#D4A017" stroke-width="1.5" marker-end="url(#arr)"/>
  <line x1="650" y1="738" x2="650" y2="755" stroke="#D4A017" stroke-width="1.5" marker-end="url(#arr)"/>
  <rect x="60" y="758" width="380" height="60" rx="8" fill="white" stroke="#D4A017" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="780" fill="#1B2A4A" font-size="12" font-weight="bold">3. Tax Truing / Aggregation</text>
  <text x="80" y="797" fill="#555" font-size="10">Statement-level tax true-up. Cohort-scoped tax</text>
  <text x="80" y="810" fill="#555" font-size="10">pools computed across full cycle population.</text>
  <rect x="460" y="758" width="380" height="60" rx="8" fill="white" stroke="#D4A017" stroke-width="1.5" filter="url(#sh)"/>
  <text x="480" y="780" fill="#1B2A4A" font-size="12" font-weight="bold">4. Invoice Generation</text>
  <text x="480" y="797" fill="#555" font-size="10">Format statement, generate print/electronic</text>
  <text x="480" y="810" fill="#555" font-size="10">billing files. The actual &#x201C;bill.&#x201D;</text>
  <line x1="250" y1="818" x2="250" y2="835" stroke="#D4A017" stroke-width="1.5" marker-end="url(#arr)"/>
  <line x1="650" y1="818" x2="650" y2="835" stroke="#D4A017" stroke-width="1.5" marker-end="url(#arr)"/>
  <rect x="60" y="838" width="380" height="60" rx="8" fill="white" stroke="#D4A017" stroke-width="1.5" filter="url(#sh)"/>
  <text x="80" y="860" fill="#1B2A4A" font-size="12" font-weight="bold">5. GL Posting / Revenue Recognition</text>
  <text x="80" y="877" fill="#555" font-size="10">Journal entries by revenue category.</text>
  <text x="80" y="890" fill="#555" font-size="10">Revenue recognized at invoice generation.</text>
  <rect x="460" y="838" width="380" height="60" rx="8" fill="white" stroke="#D4A017" stroke-width="1.5" filter="url(#sh)"/>
  <text x="480" y="860" fill="#1B2A4A" font-size="12" font-weight="bold">6. Downstream Triggers</text>
  <text x="480" y="877" fill="#555" font-size="10">Autopay extracts, dunning evaluation,</text>
  <text x="480" y="890" fill="#555" font-size="10">print file transfer, e-bill portal push.</text>
  <!-- FAILURE ZONE overlay -->
  <rect x="45" y="668" width="1010" height="240" rx="8" fill="none" stroke="#CC3333" stroke-width="3" stroke-dasharray="8,4"/>
  <rect x="52" y="903" width="260" height="22" rx="4" fill="#FDECEA" stroke="#CC3333" stroke-width="1"/>
  <text x="60" y="918" fill="#CC3333" font-size="10" font-weight="bold">&#x26A0; DISK FAILURE OCCURRED HERE &#x2014; mid-batch</text>
  <!-- What broke callout -->
  <rect x="380" y="920" width="670" height="80" rx="8" fill="#FDECEA" stroke="#CC3333" stroke-width="1.5" filter="url(#sh)"/>
  <text x="400" y="940" fill="#CC3333" font-size="11" font-weight="bold">What broke was NOT individual charge posting (Mode 1 &#x2014; already done)</text>
  <text x="400" y="957" fill="#CC3333" font-size="11" font-weight="bold">What broke was cycle-level aggregation, tax pools, invoice records, GL interface</text>
  <text x="400" y="975" fill="#CC3333" font-size="10">Some subscriber invoices finalized &#x2713; | Some partially aggregated &#x2717; | Cohort totals incomplete &#x2717;</text>
  <text x="400" y="990" fill="#CC3333" font-size="10">This is why system appeared &#x201C;online&#x201D; &#x2014; underlying charges were there, cycle-level state drifted</text>
  <!-- ===== OUTPUTS ===== -->
  <line x1="330" y1="1013" x2="330" y2="1045" stroke="#2D8C4E" stroke-width="1.5" marker-end="url(#arrGreen)"/>
  <line x1="770" y1="1013" x2="770" y2="1045" stroke="#2D8C4E" stroke-width="1.5" marker-end="url(#arrGreen)"/>
  <rect x="140" y="1048" width="380" height="65" rx="10" fill="#D4EDDA" stroke="#2D8C4E" stroke-width="1.5" filter="url(#sh)"/>
  <text x="330" y="1072" text-anchor="middle" fill="#1B2A4A" font-size="13" font-weight="bold">Invoice Output</text>
  <text x="330" y="1090" text-anchor="middle" fill="#555" font-size="10">Print files &#x2192; Mail vendor</text>
  <text x="330" y="1104" text-anchor="middle" fill="#555" font-size="10">Electronic bills &#x2192; Customer portal</text>
  <rect x="580" y="1048" width="380" height="65" rx="10" fill="#D4EDDA" stroke="#2D8C4E" stroke-width="1.5" filter="url(#sh)"/>
  <text x="770" y="1072" text-anchor="middle" fill="#1B2A4A" font-size="13" font-weight="bold">Financial Output</text>
  <text x="770" y="1090" text-anchor="middle" fill="#555" font-size="10">GL journal entries &#x2192; SAP / Oracle</text>
  <text x="770" y="1104" text-anchor="middle" fill="#555" font-size="10">Revenue recognition by category</text>
  <!-- ===== KEY INSIGHT BOX ===== -->
  <rect x="55" y="1135" width="990" height="90" rx="10" fill="#1B2A4A" filter="url(#sh)"/>
  <text x="550" y="1160" text-anchor="middle" fill="white" font-size="14" font-weight="bold">KEY ARCHITECTURAL INSIGHT</text>
  <text x="550" y="1182" text-anchor="middle" fill="#AACCEE" font-size="11.5">Mode 1 (continuous): Individual charges post to ledger as events occur &#x2014; TMF protects each transaction</text>
  <text x="550" y="1200" text-anchor="middle" fill="#AACCEE" font-size="11.5">Mode 2 (batch): Cycle aggregation, tax truing, invoicing, GL posting &#x2014; application-level batch orchestration</text>
  <text x="550" y="1218" text-anchor="middle" fill="#FFD700" font-size="11.5" font-weight="bold">TMF protects Mode 1. Nothing protects Mode 2 atomically. That is the gap the incident exposed.</text>
  <!-- Legend -->
  <rect x="55" y="1245" width="990" height="55" rx="8" fill="white" stroke="#CCC" stroke-width="0.5"/>
  <text x="75" y="1268" fill="#1B2A4A" font-size="10" font-weight="bold">LEGEND:</text>
  <rect x="150" y="1256" width="14" height="14" rx="3" fill="#F0F8F0" stroke="#2D8C4E"/>
  <text x="170" y="1268" fill="#555" font-size="9.5">Mode 1 &#x2014; Continuous</text>
  <rect x="300" y="1256" width="14" height="14" rx="3" fill="#FFF8F0" stroke="#D4A017"/>
  <text x="320" y="1268" fill="#555" font-size="9.5">Mode 2 &#x2014; Batch (4x/mo)</text>
  <rect x="460" y="1256" width="14" height="14" rx="3" fill="#FDECEA" stroke="#CC3333"/>
  <text x="480" y="1268" fill="#555" font-size="9.5">Failure zone</text>
  <rect x="580" y="1256" width="14" height="14" rx="3" fill="#D4EDDA" stroke="#2D8C4E"/>
  <text x="600" y="1268" fill="#555" font-size="9.5">Output</text>
  <rect x="680" y="1256" width="14" height="14" rx="3" fill="#1B2A4A"/>
  <text x="700" y="1268" fill="#555" font-size="9.5">Key insight</text>
  <text x="75" y="1290" fill="#888" font-size="9">Cable MSO &#x2014; HP NonStop (Tandem) &#x2014; 5M subscribers &#x2014; 4 billing cycles x 1.25M each &#x2014; TMF protects transactions, not batch cycles</text>
</svg>
