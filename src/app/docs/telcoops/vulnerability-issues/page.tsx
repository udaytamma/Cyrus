import { TelcoOpsDocsLayout } from "@/components/TelcoOpsDocsLayout";

export const metadata = {
  title: "Security Posture Review | TelcoOps",
  description: "Pre-deployment security assessment: findings, compliance mapping, remediation, and residual risk for the TelcoOps Platform.",
};

export default function VulnerabilityIssuesPage() {
  return (
    <TelcoOpsDocsLayout>
      <article className="prose prose-slate max-w-none dark:prose-invert">
        <h1>Security Posture Review</h1>
        <p className="lead">
          Pre-deployment security assessment of the TelcoOps NOC Incident RCA Platform. Covers scope,
          methodology, classified findings with compliance mapping, remediation outcomes, process
          improvements, and accepted residual risk.
        </p>

        {/* ── Executive Summary ── */}
        <h2>Executive Summary</h2>
        <p>
          A targeted security review of the TelcoOps Platform identified <strong>8 findings</strong> across
          authentication, tenant isolation, data privacy, infrastructure, and API hardening. Two were classified
          as <strong>Critical</strong> (authentication bypass, tenant spoofing), two as <strong>High</strong> (unauthenticated
          dashboard, permissive CORS), and four as <strong>Medium/Low</strong> (missing rate limiting, webhook
          signature gaps, health endpoint disclosure, and absence of auth event logging).
        </p>
        <p>
          Both Critical findings were remediated within a 48-hour hardening cycle. High and Medium/Low findings
          are documented as accepted residual risk with mitigations in place. Post-remediation, the platform
          enforces fail-closed authentication, server-bound tenant identity, PII redaction on all API responses,
          and non-root container execution.
        </p>

        {/* ── Scope & Methodology ── */}
        <h2>Scope &amp; Methodology</h2>
        <p><strong>Assessment scope:</strong> API authentication (3-tier token model), tenant isolation, PII handling
          in incident data, LLM prompt security, RAG pipeline access, infrastructure exposure, input validation,
          CORS policy, webhook ingestion, and audit logging.</p>
        <p><strong>Out of scope:</strong> Penetration testing, network-layer DDoS, Gemini API-side security,
          supply chain audit, and Streamlit framework vulnerabilities.</p>
        <p><strong>Method:</strong> Manual code review of all API endpoints, auth middleware, tenant isolation logic,
          data redaction pipeline, Docker configuration, and database schema. Cross-referenced against
          NIST SP 800-53 access control requirements and telecom data handling best practices.</p>
        <p><strong>Review window:</strong> 48 hours, detection through verification.</p>

        {/* ── Findings Summary Table ── */}
        <h2>Findings Summary</h2>
        <div className="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Finding</th>
                <th>Severity</th>
                <th>Compliance</th>
                <th>Status</th>
                <th>Resolution</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>SEC-01</td>
                <td>Authentication bypass by omission</td>
                <td><span className="text-red-600 dark:text-red-400 font-semibold">Critical</span></td>
                <td>NIST AC-3, AC-6</td>
                <td>Remediated</td>
                <td>&lt;24h</td>
              </tr>
              <tr>
                <td>SEC-02</td>
                <td>Tenant identity spoofable via client header</td>
                <td><span className="text-red-600 dark:text-red-400 font-semibold">Critical</span></td>
                <td>NIST AC-4, SC-4</td>
                <td>Remediated</td>
                <td>&lt;24h</td>
              </tr>
              <tr>
                <td>SEC-03</td>
                <td>Streamlit dashboard unauthenticated</td>
                <td><span className="text-orange-600 dark:text-orange-400 font-semibold">High</span></td>
                <td>NIST AC-3</td>
                <td>Accepted</td>
                <td>Mitigated</td>
              </tr>
              <tr>
                <td>SEC-04</td>
                <td>Permissive CORS policy</td>
                <td><span className="text-orange-600 dark:text-orange-400 font-semibold">High</span></td>
                <td>OWASP A5</td>
                <td>Accepted</td>
                <td>Mitigated</td>
              </tr>
              <tr>
                <td>SEC-05</td>
                <td>No API rate limiting</td>
                <td><span className="text-amber-600 dark:text-amber-400 font-semibold">Medium</span></td>
                <td>OWASP A4</td>
                <td>Accepted</td>
                <td>Documented</td>
              </tr>
              <tr>
                <td>SEC-06</td>
                <td>Webhook ingestion lacks signature validation</td>
                <td><span className="text-amber-600 dark:text-amber-400 font-semibold">Medium</span></td>
                <td>NIST SC-8</td>
                <td>Accepted</td>
                <td>Documented</td>
              </tr>
              <tr>
                <td>SEC-07</td>
                <td>Health endpoint leaks component status</td>
                <td><span className="text-blue-600 dark:text-blue-400 font-semibold">Low</span></td>
                <td>CWE-200</td>
                <td>Accepted</td>
                <td>Mitigated</td>
              </tr>
              <tr>
                <td>SEC-08</td>
                <td>No authentication event logging</td>
                <td><span className="text-blue-600 dark:text-blue-400 font-semibold">Low</span></td>
                <td>NIST AU-2</td>
                <td>Accepted</td>
                <td>Documented</td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* ── Detailed Findings ── */}
        <h2>Detailed Findings</h2>

        {/* SEC-01 */}
        <h3>SEC-01: Authentication Bypass by Omission <span className="text-red-600 dark:text-red-400">[Critical]</span></h3>
        <p><strong>Description:</strong> Three-tier token authentication (API, Admin, Metrics) was optional
          by default. If <code>API_TOKEN</code>, <code>ADMIN_TOKEN</code>, or <code>METRICS_TOKEN</code> were
          not set, auth middleware returned success unconditionally&mdash;allowing unauthenticated access to
          incident generation, RCA execution, data deletion, metrics, and audit log endpoints.</p>
        <p><strong>Risk:</strong> Full API exposure in any deployment where environment variables were
          incomplete. An attacker could invoke <code>POST /generate</code> to flood the system with synthetic
          incidents, <code>POST /rca/&#123;id&#125;/llm</code> to consume Gemini API quota, or <code>POST /reset</code> to
          permanently delete all incidents, alerts, and RCA artifacts. Blast radius: all protected endpoints
          across 3 token scopes.</p>
        <p><strong>Root cause:</strong> Auth was designed for local development convenience&mdash;tokens
          treated as opt-in rather than fail-closed. The <code>require_api_token()</code> function
          short-circuited with <code>return</code> when no token was configured, silently granting access.</p>
        <p><strong>Remediation:</strong> Added Pydantic model validator that raises <code>ValueError</code> when <code>ENVIRONMENT=production</code> and
          any of the 3 required tokens is missing. Service refuses to start without all secrets.
          Auth middleware validates tokens via <code>X-API-Key</code> header or <code>Authorization: Bearer</code> format
          with whitespace stripping to prevent padding bypass.</p>
        <p><strong>Verification:</strong> Production startup fails with explicit error listing missing settings.
          Streamlit dashboard updated to inject <code>X-API-Key</code> headers on all internal API calls.</p>
        <p><strong>NIST mapping:</strong> AC-3 (Access Enforcement), AC-6 (Least Privilege).</p>

        {/* SEC-02 */}
        <h3>SEC-02: Tenant Identity Spoofable via Client Header <span className="text-red-600 dark:text-red-400">[Critical]</span></h3>
        <p><strong>Description:</strong> Tenant identity was derived from a client-supplied <code>X-Tenant-Id</code> header.
          Any caller could set an arbitrary tenant ID and access another tenant&apos;s incidents, RCA artifacts,
          and audit logs. Database queries filtered by <code>tenant_id</code> column, but the value was
          entirely client-controlled.</p>
        <p><strong>Risk:</strong> Complete tenant isolation bypass. In a multi-tenant deployment, an attacker
          could enumerate tenant data, read RCA reports containing operational intelligence, or delete
          another tenant&apos;s incidents via the <code>POST /reset</code> endpoint. The tenant ID also appeared
          in audit logs, enabling log pollution.</p>
        <p><strong>Root cause:</strong> Tenant isolation was designed for flexibility (arbitrary tenants via headers)
          without considering that client-supplied identity is inherently untrusted. No server-side binding
          existed between authenticated tokens and tenant scope.</p>
        <p><strong>Remediation:</strong> When tenant isolation is enabled, the server now binds tenant identity
          to <code>TELEOPS_TENANT_ID</code> (server configuration). Requests with a mismatched tenant header
          are rejected with 403. Tenant IDs are SHA-256 hashed to aliases (<code>tenant-&#123;hash8&#125;</code>) for
          logging, preventing raw tenant identifiers from appearing in audit trails.</p>
        <p><strong>Verification:</strong> Production startup enforces <code>TELEOPS_TENANT_ID</code> when <code>REQUIRE_TENANT_ID=true</code>.
          API rejects cross-tenant requests. Audit logs contain only hashed aliases.</p>
        <p><strong>NIST mapping:</strong> AC-4 (Information Flow Enforcement), SC-4 (Information in Shared System Resources).</p>

        {/* SEC-03 */}
        <h3>SEC-03: Streamlit Dashboard Unauthenticated <span className="text-orange-600 dark:text-orange-400">[High]</span></h3>
        <p><strong>Description:</strong> The Streamlit dashboard (Incident Generator, Observability, LLM Trace pages)
          has no authentication layer. Anyone with network access to port 8501 can generate incidents,
          trigger LLM-powered RCA, view operational metrics, and invoke the destructive reset operation
          through the UI.</p>
        <p><strong>Risk:</strong> Dashboard acts as an unauthenticated proxy to all API capabilities. Even
          with API-level token auth, the dashboard holds tokens in its environment and forwards them
          transparently. An attacker accessing the dashboard bypasses all API-level controls.</p>
        <p><strong>Accepted risk:</strong> Streamlit lacks native authentication middleware. The dashboard
          is deployed behind Railway&apos;s infrastructure. For production multi-tenant use, a reverse proxy
          with authentication (e.g., Cloudflare Access, nginx basic auth) is documented as a prerequisite.
          API documentation endpoints (<code>/docs</code>, <code>/redoc</code>) are disabled in production.</p>

        {/* SEC-04 */}
        <h3>SEC-04: Permissive CORS Policy <span className="text-orange-600 dark:text-orange-400">[High]</span></h3>
        <p><strong>Description:</strong> CORS middleware configured
          with <code>allow_methods=[&quot;*&quot;]</code> and <code>allow_headers=[&quot;*&quot;]</code>,
          permitting all HTTP methods and headers from allowed origins.</p>
        <p><strong>Risk:</strong> If an allowed origin is compromised, the attacker gains full method access
          (including POST for incident generation, RCA triggering, and data deletion) rather than the
          minimum required set. Elevated to High because POST operations in TelcoOps can trigger
          expensive LLM calls and destructive data operations.</p>
        <p><strong>Accepted risk:</strong> Origin list is restricted to <code>localhost:8501</code> (Streamlit)
          and <code>localhost:3000</code> (dev). Docker Compose further restricts
          to <code>http://localhost:8501</code> only. Production deployments should narrow methods
          to <code>GET, POST</code> and headers to specific auth headers. Documented in deployment checklist.</p>

        {/* SEC-05 */}
        <h3>SEC-05: No API Rate Limiting <span className="text-amber-600 dark:text-amber-400">[Medium]</span></h3>
        <p><strong>Description:</strong> No rate limiting middleware protects the API. Each <code>POST /rca/&#123;id&#125;/llm</code> request
          triggers a full LLM inference cycle (Gemini API call + RAG retrieval + prompt construction),
          and each <code>POST /generate</code> request creates incidents with associated alerts in the database.</p>
        <p><strong>Risk:</strong> Unbounded requests could exhaust Gemini API quota (cost amplification),
          fill the SQLite database, and saturate the RAG index. No per-IP or per-token throttling exists.
          LLM-based RCA is the most expensive operation (~2-5s per call with external API dependency).</p>
        <p><strong>Accepted risk:</strong> Platform is deployed behind Railway infrastructure which provides
          basic DDoS protection. Application-level rate limiting documented as a future enhancement.
          Safe mode kill switch (<code>SAFE_MODE_ENABLED</code>) provides a manual circuit breaker
          for LLM operations.</p>

        {/* SEC-06 */}
        <h3>SEC-06: Webhook Ingestion Lacks Signature Validation <span className="text-amber-600 dark:text-amber-400">[Medium]</span></h3>
        <p><strong>Description:</strong> ServiceNow and Jira webhook endpoints (<code>POST /integrations/servicenow/webhook</code>,
          <code>POST /integrations/jira/webhook</code>) are protected by admin token but do not validate
          webhook payload signatures (HMAC). Payload structure is validated via Pydantic schemas.</p>
        <p><strong>Risk:</strong> If the admin token is compromised, an attacker can inject arbitrary webhook
          events that are logged to the integration events file. In a production ITSM integration, this
          could pollute incident correlation data.</p>
        <p><strong>Accepted risk:</strong> Admin token provides first-line protection. Webhook payloads are
          validated against strict Pydantic schemas, rejecting malformed data. Events are append-only
          to log files (no code execution). HMAC signature validation is documented as a prerequisite
          for production ITSM integration.</p>

        {/* SEC-07 */}
        <h3>SEC-07: Health Endpoint Information Disclosure <span className="text-blue-600 dark:text-blue-400">[Low]</span></h3>
        <p><strong>Description:</strong> The <code>GET /health</code> endpoint is unauthenticated and returns
          component-level status (database, LLM provider, RAG index availability).</p>
        <p><strong>Risk:</strong> An attacker can determine which infrastructure components are degraded,
          useful for timing attacks or identifying exploitable states.</p>
        <p><strong>Accepted risk:</strong> Health endpoints are conventionally unauthenticated for orchestrator
          integration (Railway, Kubernetes). Endpoint returns only boolean status per component&mdash;no
          connection strings, software versions, or internal IPs. OpenAPI/Swagger docs are disabled
          in production (<code>docs_url=None</code>, <code>redoc_url=None</code>).</p>

        {/* SEC-08 */}
        <h3>SEC-08: No Authentication Event Logging <span className="text-blue-600 dark:text-blue-400">[Low]</span></h3>
        <p><strong>Description:</strong> Token validation successes and failures are not logged at the
          application level. Auth middleware silently returns 401 without recording the attempt.</p>
        <p><strong>Risk:</strong> No visibility into brute-force token guessing or unauthorized access patterns.
          Incident response would lack auth event correlation.</p>
        <p><strong>Accepted risk:</strong> RCA review decisions are logged to an immutable audit
          trail (<code>/storage/audit_log.jsonl</code>) with structured JSON, size-based rotation (5MB, 3 backups),
          and UTC timestamps. Integration events are similarly logged. Auth event logging is documented
          as a future enhancement alongside centralized log aggregation.</p>

        {/* ── Security Controls In Place ── */}
        <h2>Security Controls In Place</h2>
        <p>The following controls were verified as operating correctly during the assessment:</p>
        <ul>
          <li><strong>PII redaction pipeline:</strong> Automatic regex-based redaction of IP addresses
            and email addresses from all RCA output, evidence, and API responses.
            Tenant IDs hashed to aliases (<code>tenant-&#123;sha256[:8]&#125;</code>) in audit logs.</li>
          <li><strong>Input validation:</strong> All API inputs validated via Pydantic v2 with strict constraints&mdash;incident
            types are whitelisted enums, numeric fields have min/max bounds (e.g., <code>alert_rate_per_min: 1-100</code>,
            <code>duration_min: 1-60</code>), and reviewer names are length-limited (128 chars).</li>
          <li><strong>SQL injection protection:</strong> All database queries use SQLAlchemy ORM (no raw SQL string
            construction). Indexed <code>tenant_id</code> columns enable efficient tenant-scoped queries.</li>
          <li><strong>Idempotent artifact review:</strong> RCA artifacts can only be reviewed once (status
            must be <code>pending_review</code>). Subsequent review attempts return 409 Conflict.</li>
          <li><strong>Non-root container execution:</strong> Dockerfile creates <code>teleops</code> user and
            switches to non-root. RAG corpus mounted read-only (<code>:ro</code>).</li>
          <li><strong>Structured audit logging:</strong> Append-only JSONL with UTC timestamps, size-based rotation,
            and tenant-scoped filtering on read. Covers RCA reviews and integration events.</li>
          <li><strong>Production API docs disabled:</strong> Swagger UI and ReDoc hidden
            when <code>ENVIRONMENT=production</code>, preventing endpoint enumeration.</li>
        </ul>

        {/* ── Process Improvements ── */}
        <h2>Process Improvements</h2>
        <p>The root cause across SEC-01 and SEC-02 was a shared anti-pattern: security controls
          designed as opt-in features rather than fail-closed defaults. The following process changes
          prevent recurrence:</p>
        <ul>
          <li><strong>Startup validation gate:</strong> Production configuration is validated at process
            start via Pydantic <code>model_validator</code>. Missing secrets cause immediate failure with
            explicit error messages listing every missing setting&mdash;no silent degradation.</li>
          <li><strong>Environment-aware defaults:</strong> Local development permits optional auth and
            single-tenant mode. Production enforces all 3 tokens + tenant ID
            via <code>ENVIRONMENT</code> discriminator.</li>
          <li><strong>Server-bound identity:</strong> Tenant identity is bound to server configuration,
            not client headers. Client-supplied <code>X-Tenant-Id</code> is validated against the
            server-side value, not trusted as authoritative.</li>
          <li><strong>Redaction by default:</strong> PII redaction runs on all API responses, not as
            an opt-in filter. Raw incident data in the database is the system of record; redacted
            data is what crosses the API boundary.</li>
          <li><strong>Audit remediation cycle:</strong> Structured security review with findings tracked
            to resolution, including severity classification and compliance mapping.</li>
        </ul>

        {/* ── Residual Risk ── */}
        <h2>Residual Risk</h2>
        <p>The following risks are accepted with documented rationale. These represent conscious
          trade-offs appropriate for a portfolio-grade platform, not gaps in awareness:</p>
        <div className="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Risk</th>
                <th>Severity</th>
                <th>Mitigation</th>
                <th>Rationale</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Streamlit dashboard unauthenticated</td>
                <td>High</td>
                <td>Deploy behind reverse proxy with auth</td>
                <td>Streamlit lacks native auth; reverse proxy is standard pattern for production</td>
              </tr>
              <tr>
                <td>Permissive CORS methods/headers</td>
                <td>Medium</td>
                <td>Origin list restricted; Docker further restricts</td>
                <td>No external consumers; tighten on first integration</td>
              </tr>
              <tr>
                <td>No application-level rate limiting</td>
                <td>Medium</td>
                <td>Railway DDoS protection + safe mode kill switch</td>
                <td>LLM rate limiting requires token-aware throttling; planned for future sprint</td>
              </tr>
              <tr>
                <td>Webhook signature validation absent</td>
                <td>Medium</td>
                <td>Admin token + Pydantic schema validation</td>
                <td>HMAC validation requires ITSM-specific shared secrets; scoped for production integration</td>
              </tr>
              <tr>
                <td>Health endpoint unauthenticated</td>
                <td>Low</td>
                <td>Minimal disclosure, no sensitive data</td>
                <td>Required for orchestrator health checks</td>
              </tr>
              <tr>
                <td>No auth event logging</td>
                <td>Low</td>
                <td>RCA audit trail covers decision-level forensics</td>
                <td>Centralized logging is a prerequisite; planned alongside log aggregation</td>
              </tr>
              <tr>
                <td>Secrets in environment variables</td>
                <td>Medium</td>
                <td>Railway encrypted environment</td>
                <td>Secrets manager adds infrastructure dependency beyond portfolio scope</td>
              </tr>
              <tr>
                <td>No token expiration or rotation</td>
                <td>Low</td>
                <td>Static tokens with manual rotation</td>
                <td>Token lifecycle management requires session infrastructure; documented for maturity phase</td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* ── Metrics ── */}
        <h2>Assessment Metrics</h2>
        <div className="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Total findings</td>
                <td>8 (2 Critical, 2 High, 2 Medium, 2 Low)</td>
              </tr>
              <tr>
                <td>Findings remediated</td>
                <td>2 / 2 Critical</td>
              </tr>
              <tr>
                <td>Detection-to-resolution (Critical)</td>
                <td>&lt;24 hours</td>
              </tr>
              <tr>
                <td>Full assessment window</td>
                <td>48 hours</td>
              </tr>
              <tr>
                <td>Endpoints protected</td>
                <td>14 (across 3 token scopes: API, Admin, Metrics)</td>
              </tr>
              <tr>
                <td>Security controls verified</td>
                <td>7 (PII redaction, input validation, SQL protection, idempotency, non-root container, audit logging, API docs disabled)</td>
              </tr>
              <tr>
                <td>Residual risks accepted</td>
                <td>8 (all with documented mitigations)</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
    </TelcoOpsDocsLayout>
  );
}
