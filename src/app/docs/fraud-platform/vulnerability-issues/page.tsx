import { DocsLayout } from "@/components/DocsLayout";

export const metadata = {
  title: "Security Posture Review | Fraud Detection Platform",
  description: "Pre-deployment security assessment: findings, compliance mapping, remediation, and residual risk for the Fraud Detection Platform.",
};

export default function VulnerabilityIssuesPage() {
  return (
    <DocsLayout>
      <article className="prose prose-slate max-w-none dark:prose-invert">
        <h1>Security Posture Review</h1>
        <p className="lead">
          Pre-deployment security assessment of the Fraud Detection Platform. Covers scope, methodology,
          classified findings with compliance mapping, remediation outcomes, process improvements,
          and accepted residual risk.
        </p>

        {/* ── Executive Summary ── */}
        <h2>Executive Summary</h2>
        <p>
          A targeted security review of the Fraud Detection Platform identified <strong>7 findings</strong> across
          authentication, cryptography, infrastructure, and API hardening. Three were classified
          as <strong>Critical</strong> (authentication bypass, unencrypted evidence vault, infrastructure exposure),
          two as <strong>Medium</strong> (permissive CORS, unauthenticated health endpoint), and two
          as <strong>Low</strong> (missing rate limiting, minimal auth event logging).
        </p>
        <p>
          All Critical findings were remediated within a 48-hour hardening cycle (Feb 8&ndash;10, 2026).
          Medium and Low findings are documented as accepted residual risk with mitigations in place.
          Post-remediation, the platform enforces fail-closed authentication, encrypted evidence storage,
          and localhost-bound infrastructure by default.
        </p>

        {/* ── Scope & Methodology ── */}
        <h2>Scope &amp; Methodology</h2>
        <p><strong>Assessment scope:</strong> API authentication, data-at-rest encryption, infrastructure exposure,
          input validation, CORS policy, logging, and dependency posture.</p>
        <p><strong>Out of scope:</strong> Penetration testing, network-layer DDoS, supply chain audit, and client-side security.</p>
        <p><strong>Method:</strong> Manual code review of all API endpoints, auth middleware, evidence service,
          Docker configuration, and database schema. Cross-referenced against PCI-DSS v4.0 requirements
          for payment data handling.</p>
        <p><strong>Review window:</strong> February 8&ndash;10, 2026 (48 hours, detection through verification).</p>

        {/* ── Findings Summary Table ── */}
        <h2>Findings Summary</h2>
        <div className="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Finding</th>
                <th>Severity</th>
                <th>Compliance</th>
                <th>Status</th>
                <th>Resolution</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>SEC-01</td>
                <td>Authentication bypass by omission</td>
                <td><span className="text-red-600 dark:text-red-400 font-semibold">Critical</span></td>
                <td>PCI-DSS 7.1, 8.3</td>
                <td>Remediated</td>
                <td>&lt;24h</td>
              </tr>
              <tr>
                <td>SEC-02</td>
                <td>Evidence vault encryption optional</td>
                <td><span className="text-red-600 dark:text-red-400 font-semibold">Critical</span></td>
                <td>PCI-DSS 3.4, 3.5</td>
                <td>Remediated</td>
                <td>&lt;24h</td>
              </tr>
              <tr>
                <td>SEC-03</td>
                <td>Infrastructure services on public interfaces</td>
                <td><span className="text-red-600 dark:text-red-400 font-semibold">Critical</span></td>
                <td>PCI-DSS 1.3</td>
                <td>Remediated</td>
                <td>&lt;24h</td>
              </tr>
              <tr>
                <td>SEC-04</td>
                <td>Permissive CORS policy</td>
                <td><span className="text-amber-600 dark:text-amber-400 font-semibold">Medium</span></td>
                <td>OWASP A5</td>
                <td>Accepted</td>
                <td>Mitigated</td>
              </tr>
              <tr>
                <td>SEC-05</td>
                <td>Health endpoint leaks component status</td>
                <td><span className="text-amber-600 dark:text-amber-400 font-semibold">Medium</span></td>
                <td>CWE-200</td>
                <td>Accepted</td>
                <td>Mitigated</td>
              </tr>
              <tr>
                <td>SEC-06</td>
                <td>No API rate limiting</td>
                <td><span className="text-blue-600 dark:text-blue-400 font-semibold">Low</span></td>
                <td>OWASP A4</td>
                <td>Accepted</td>
                <td>Documented</td>
              </tr>
              <tr>
                <td>SEC-07</td>
                <td>No auth event logging</td>
                <td><span className="text-blue-600 dark:text-blue-400 font-semibold">Low</span></td>
                <td>PCI-DSS 10.2</td>
                <td>Accepted</td>
                <td>Documented</td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* ── Detailed Findings ── */}
        <h2>Detailed Findings</h2>

        {/* SEC-01 */}
        <h3>SEC-01: Authentication Bypass by Omission <span className="text-red-600 dark:text-red-400">[Critical]</span></h3>
        <p><strong>Description:</strong> Token-based authentication across 18+ endpoints was optional.
          If <code>API_TOKEN</code>, <code>ADMIN_TOKEN</code>, or <code>METRICS_TOKEN</code> were
          not set, auth middleware returned success unconditionally&mdash;allowing unauthenticated access to
          decisioning, policy mutation, and metrics endpoints.</p>
        <p><strong>Risk:</strong> Full API exposure in any deployment where environment variables were
          incomplete. An attacker could invoke <code>POST /decide</code> to probe fraud rules, <code>POST /policy/reload</code> to
          mutate policy, or <code>GET /metrics</code> to extract operational telemetry. Blast radius: all 18 protected endpoints
          across 3 token scopes (API, Admin, Metrics).</p>
        <p><strong>Root cause:</strong> Auth was designed for local development convenience&mdash;tokens
          were treated as opt-in rather than fail-closed. No environment-aware validation existed at startup.</p>
        <p><strong>Remediation:</strong> Added startup validator that raises <code>ValueError</code> when <code>APP_ENV=production</code> and
          any of the 3 required tokens is missing. Service refuses to start without all secrets configured.
          Auth middleware validates tokens via <code>X-API-Key</code> header or <code>Authorization: Bearer</code> format.</p>
        <p><strong>Verification:</strong> Unit test <code>test_production_requires_security_settings()</code> asserts
          startup failure when tokens are absent. Dashboard integration updated to inject <code>X-API-Key</code> headers
          on all internal API calls.</p>
        <p><strong>PCI-DSS mapping:</strong> Requirement 7.1 (restrict access by business need), Requirement 8.3 (authenticate
          all access to system components).</p>

        {/* SEC-02 */}
        <h3>SEC-02: Evidence Vault Encryption Optional <span className="text-red-600 dark:text-red-400">[Critical]</span></h3>
        <p><strong>Description:</strong> The evidence vault stores raw device IDs, IP addresses, and device
          fingerprints linked to fraud decisions. Encryption (Fernet/AES-128-CBC + HMAC-SHA256) and
          identifier hashing (HMAC-SHA256) were silently skipped when <code>EVIDENCE_VAULT_KEY</code> and <code>EVIDENCE_HASH_KEY</code> were
          not configured, falling back to plaintext storage.</p>
        <p><strong>Risk:</strong> Evidence records containing PII stored without cryptographic protection.
          A database compromise would expose raw identifiers across all historical fraud decisions.
          The two-table architecture (public <code>transaction_evidence</code> with hashed fields + encrypted <code>evidence_vault</code> with
          TTL) was designed for PCI compliance but was ineffective without keys.</p>
        <p><strong>Root cause:</strong> Same development-convenience pattern as SEC-01. Encryption was
          a feature toggle rather than a security invariant. The <code>_hash_value()</code> method returned <code>None</code> when
          no key was configured, storing null hashes instead of failing.</p>
        <p><strong>Remediation:</strong> Both <code>EVIDENCE_VAULT_KEY</code> (Fernet symmetric key)
          and <code>EVIDENCE_HASH_KEY</code> (HMAC secret) are now enforced at startup in production.
          Evidence capture always writes encrypted ciphertext with automatic TTL expiration
          per <code>EVIDENCE_RETENTION_DAYS</code> (default: 730 days). A <code>purge_evidence_vault.py</code> script
          handles retention compliance for expired records.</p>
        <p><strong>Verification:</strong> Startup validator rejects production configuration without both keys.
          Evidence service logs confirm encrypted writes on every capture operation.</p>
        <p><strong>PCI-DSS mapping:</strong> Requirement 3.4 (render PAN unreadable anywhere it is stored),
          Requirement 3.5 (protect keys used to secure stored data).</p>

        {/* SEC-03 */}
        <h3>SEC-03: Infrastructure Services on Public Interfaces <span className="text-red-600 dark:text-red-400">[Critical]</span></h3>
        <p><strong>Description:</strong> Redis (velocity counters), PostgreSQL (evidence storage), and
          Prometheus (metrics collection) were published on <code>0.0.0.0</code> in <code>docker-compose.yml</code>,
          binding to all network interfaces.</p>
        <p><strong>Risk:</strong> Any deployment beyond localhost exposed Redis (unauthenticated by default),
          PostgreSQL (password-only), and Prometheus (unauthenticated) to the public internet.
          An attacker could read/modify velocity counters to bypass fraud detection, access evidence
          records directly, or scrape operational metrics to map system behavior.</p>
        <p><strong>Root cause:</strong> Default Docker Compose port mappings
          use <code>0.0.0.0</code> when no bind address is specified. The configuration was written
          for local development without considering deployment context.</p>
        <p><strong>Remediation:</strong> All service ports bound to <code>127.0.0.1</code> (loopback only).
          Public exposure now requires explicit intent via configuration override. API container
          runs as non-root user (<code>appuser</code>) with health check configured. Services communicate
          over an isolated Docker bridge network (<code>fraud-network</code>).</p>
        <p><strong>Verification:</strong> Port scan confirms services unreachable from external interfaces.
          Dockerfile enforces non-root execution (UID/GID set at build time).</p>
        <p><strong>PCI-DSS mapping:</strong> Requirement 1.3 (prohibit direct public access between the
          internet and any system component in the cardholder data environment).</p>

        {/* SEC-04 */}
        <h3>SEC-04: Permissive CORS Policy <span className="text-amber-600 dark:text-amber-400">[Medium]</span></h3>
        <p><strong>Description:</strong> CORS middleware
          configured with <code>allow_methods=[&quot;*&quot;]</code> and <code>allow_headers=[&quot;*&quot;]</code>,
          permitting all HTTP methods and headers from allowed origins.</p>
        <p><strong>Risk:</strong> If an allowed origin is compromised, the attacker gains full method access
          (including PUT, DELETE) rather than the minimum required set. Origins are restricted
          to <code>localhost:3000</code> and <code>localhost:8501</code> by default, limiting exposure.</p>
        <p><strong>Root cause:</strong> Convenience default during development. No origin-method mapping
          was implemented.</p>
        <p><strong>Accepted risk:</strong> Current origin list is restricted to localhost. Production
          deployments should narrow methods to <code>GET, POST</code> and headers to specific auth headers.
          Documented in deployment checklist.</p>

        {/* SEC-05 */}
        <h3>SEC-05: Health Endpoint Information Disclosure <span className="text-amber-600 dark:text-amber-400">[Medium]</span></h3>
        <p><strong>Description:</strong> The <code>GET /health</code> endpoint is unauthenticated and returns
          component-level status (Redis, PostgreSQL, policy engine) plus the current policy version.</p>
        <p><strong>Risk:</strong> An attacker can determine infrastructure health, identify which components
          are degraded, and infer the policy version in use&mdash;useful for targeted attacks against
          known policy configurations.</p>
        <p><strong>Accepted risk:</strong> Health endpoints are conventionally unauthenticated for load balancer
          and orchestrator integration (Railway, Kubernetes). Mitigation: endpoint returns only boolean
          status per component, no connection strings, versions of infrastructure software, or internal IPs.
          Policy version disclosure is low-value given the platform is a portfolio project.</p>

        {/* SEC-06 */}
        <h3>SEC-06: No API Rate Limiting <span className="text-blue-600 dark:text-blue-400">[Low]</span></h3>
        <p><strong>Description:</strong> No rate limiting middleware protects the API. Each request
          triggers the full decision pipeline: feature computation, ML scoring, policy evaluation,
          and evidence capture.</p>
        <p><strong>Risk:</strong> Unbounded requests could exhaust Redis (velocity counters), PostgreSQL
          (evidence writes), and CPU (ML inference). No per-IP or per-token throttling exists.</p>
        <p><strong>Accepted risk:</strong> Platform is deployed behind Railway&apos;s infrastructure which provides
          basic DDoS protection. Adding application-level rate limiting (e.g., SlowAPI with Redis backend)
          is documented as a future enhancement. In-memory rate limiting is insufficient for multi-worker deployments.</p>

        {/* SEC-07 */}
        <h3>SEC-07: No Authentication Event Logging <span className="text-blue-600 dark:text-blue-400">[Low]</span></h3>
        <p><strong>Description:</strong> Token validation successes and failures are not logged at the
          application level. Auth middleware silently returns 401 without recording the attempt.</p>
        <p><strong>Risk:</strong> No visibility into brute-force token guessing or unauthorized access patterns.
          Incident response would lack auth event correlation.</p>
        <p><strong>Accepted risk:</strong> Database-level audit trail (immutable <code>transaction_evidence</code>,
          <code>policy_audit_log</code>, <code>idempotency_records</code>) provides decision-level
          forensics. Auth event logging is documented as a future enhancement alongside centralized
          log aggregation.</p>

        {/* ── Process Improvements ── */}
        <h2>Process Improvements</h2>
        <p>The root cause across SEC-01 through SEC-03 was a shared anti-pattern: security controls
          designed as opt-in features rather than fail-closed defaults. The following process changes
          prevent recurrence:</p>
        <ul>
          <li><strong>Startup validation gate:</strong> Production configuration is validated at process
            start. Missing secrets cause immediate failure with explicit error messages&mdash;no silent
            degradation to insecure defaults.</li>
          <li><strong>Environment-aware defaults:</strong> Local development permits optional auth and
            unencrypted storage. Production enforces all 5 security settings (3 tokens + 2 vault keys)
            via <code>APP_ENV</code> discriminator.</li>
          <li><strong>Security test coverage:</strong> Dedicated <code>test_security_settings.py</code> validates
            that production startup fails without required secrets. CI enforces 70% overall test coverage.</li>
          <li><strong>Non-root container execution:</strong> Dockerfile creates and switches
            to <code>appuser</code> at build time, reducing blast radius of any container escape.</li>
          <li><strong>Audit remediation cycle:</strong> Two structured audit passes (L7 audit + Principal TPM review)
            were conducted with findings tracked to resolution, including dead code removal to reduce
            attack surface.</li>
        </ul>

        {/* ── Residual Risk ── */}
        <h2>Residual Risk</h2>
        <p>The following risks are accepted with documented rationale. These represent conscious
          trade-offs appropriate for a portfolio-grade platform, not gaps in awareness:</p>
        <div className="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Risk</th>
                <th>Severity</th>
                <th>Mitigation</th>
                <th>Rationale</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>No application-level rate limiting</td>
                <td>Low</td>
                <td>Railway infrastructure DDoS protection</td>
                <td>Multi-worker rate limiting requires distributed state (Redis); planned for future sprint</td>
              </tr>
              <tr>
                <td>Permissive CORS methods/headers</td>
                <td>Low</td>
                <td>Origin list restricted to localhost</td>
                <td>No cross-origin consumers in current deployment; tighten on first external integration</td>
              </tr>
              <tr>
                <td>Health endpoint unauthenticated</td>
                <td>Low</td>
                <td>Minimal information disclosure</td>
                <td>Required for orchestrator health checks; no sensitive data exposed</td>
              </tr>
              <tr>
                <td>No auth event logging</td>
                <td>Low</td>
                <td>Database audit trail covers decisions</td>
                <td>Centralized logging is a prerequisite; planned alongside log aggregation</td>
              </tr>
              <tr>
                <td>Vault key rotation not automated</td>
                <td>Medium</td>
                <td>Manual rotation documented</td>
                <td>Key rotation requires re-encryption migration; scoped for operational maturity phase</td>
              </tr>
              <tr>
                <td>Secrets in environment variables</td>
                <td>Medium</td>
                <td>Railway encrypted environment</td>
                <td>Secrets manager (Vault, AWS SM) adds infrastructure dependency beyond portfolio scope</td>
              </tr>
            </tbody>
          </table>
        </div>

        {/* ── Metrics ── */}
        <h2>Assessment Metrics</h2>
        <div className="overflow-x-auto">
          <table>
            <thead>
              <tr>
                <th>Metric</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Total findings</td>
                <td>7 (3 Critical, 2 Medium, 2 Low)</td>
              </tr>
              <tr>
                <td>Findings remediated</td>
                <td>3 / 3 Critical</td>
              </tr>
              <tr>
                <td>Detection-to-resolution (Critical)</td>
                <td>&lt;24 hours</td>
              </tr>
              <tr>
                <td>Full assessment window</td>
                <td>48 hours (Feb 8&ndash;10, 2026)</td>
              </tr>
              <tr>
                <td>Endpoints hardened</td>
                <td>18 (across 3 token scopes)</td>
              </tr>
              <tr>
                <td>Security test assertions added</td>
                <td>5 (startup validation, token enforcement)</td>
              </tr>
              <tr>
                <td>Residual risks accepted</td>
                <td>6 (all Low or Medium with mitigations)</td>
              </tr>
            </tbody>
          </table>
        </div>
      </article>
    </DocsLayout>
  );
}
